{% extends "base.html" %}

{% block title %}Личный кабинет — ИС ОЭРСК{% endblock %}

{% block content %}

<div class="dash-header">
    <h1>Личный кабинет</h1>
    <p class="dash-subtitle">Добро пожаловать, <strong>{{ user.full_name }}</strong> ({{ {
        'admin': 'Администратор',
        'manager': 'Менеджер',
        'employee': 'Сотрудник'
    }[user.role.name] }})</p>
</div>

<!-- Полученные оценки -->
{% if received_evals %}
<div class="dash-section">
    <h2>Ваши оценки</h2>
    <p>Результаты оценки эффективности по метрикам.</p>
    <table class="dash-table">
        <thead>
            <tr>
                <th>Метрика</th>
                <th>Категория</th>
                <th>Балл</th>
                <th>Макс.</th>
                <th>Цикл</th>
                <th>Дата</th>
            </tr>
        </thead>
        <tbody>
            {% for eval in received_evals %}
            <tr>
                <td>{{ eval.metric.name }}</td>
                <td>{{ eval.metric.category.name }}</td>
                <td><strong>{{ "%.1f"|format(eval.score) }}</strong></td>
                <td>{{ eval.metric.max_score }}</td>
                <td>{{ eval.cycle.name }}</td>
                <td>{{ eval.evaluated_at.strftime('%d.%m.%Y') }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="mt-3">
        <a href="{{ url_for('views.employee_performance', emp_id=user.id) }}" class="btn btn-sm">
            Подробная динамика оценок
        </a>
    </div>
</div>
{% else %}
<div class="dash-alert dash-alert-info">
    У вас пока нет оценок.
</div>
{% endif %}

<!-- Обратная связь -->
{% if active_feedbacks or archived_feedbacks %}
<div class="dash-section">
    <h2>Обратная связь</h2>

    <!-- Активные уведомления -->
    {% for fb, type_name in active_feedbacks %}
    <div class="dash-feedback-item">
        <p><strong>От {{ 'анонимного пользователя' if fb.is_anonymous else fb.sender.full_name }}</strong>
           ({{ type_name }})</p>
        <p>{{ fb.content }}</p>
        <small class="dash-text-muted">{{ fb.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
        <div class="mt-1">
            <a href="{{ url_for('views.archive_feedback', fb_id=fb.id) }}" 
               class="btn btn-sm btn-outline">Прочитать</a>
        </div>
    </div>
    {% endfor %}

    <!-- Кнопка для разворачивания архива -->
    {% if archived_feedbacks %}
    <details class="mt-4">
        <summary class="dash-btn-summary">Архив (прочитанные)</summary>
        <div class="dash-feedback-archive">
            {% for fb, type_name in archived_feedbacks %}
            <div class="dash-feedback-item">
                <p><strong>От {{ 'анонимного пользователя' if fb.is_anonymous else fb.sender.full_name }}</strong>
                   ({{ type_name }})</p>
                <p>{{ fb.content }}</p>
                <small class="dash-text-muted">{{ fb.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}
</div>
{% endif %}

<!-- Ваши задачи -->
{% if tasks %}
<div class="dash-section">
    <h2>Ваши задачи</h2>
    <table class="dash-table">
        <thead>
            <tr>
                <th>Заголовок</th>
                <th>Статус</th>
                <th>Приоритет</th>
                <th>Срок</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.title }}</td>
                <td>
                    <span class="dash-badge {% if task.status == 'done' %}dash-badge-success
                           {% elif task.status == 'in_progress' %}dash-badge-warning
                           {% else %}dash-badge-secondary{% endif %}">
                        {{ {
                            'pending': 'Ожидает',
                            'in_progress': 'В работе',
                            'done': 'Выполнена'
                        }[task.status] }}
                    </span>
                </td>
                <td>
                    <span class="dash-badge {% if task.priority == 'high' %}dash-badge-danger
                           {% elif task.priority == 'medium' %}dash-badge-warning
                           {% else %}dash-badge-secondary{% endif %}">
                        {{ {
                            'low': 'Низкий',
                            'medium': 'Средний',
                            'high': 'Высокий'
                        }[task.priority] }}
                    </span>
                </td>
                <td>{{ task.deadline.strftime('%d.%m.%Y') if task.deadline else '–' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if user.role.name in ['manager', 'admin'] %}
<div class="dash-cta-wrapper">
    <div class="dash-cta-card">
        <h2>Действия для вашей роли</h2>
        <p>Вы можете управлять данными и участвовать в оценке.</p>
        <div class="dash-action-buttons">
            <a href="{{ url_for('views.evaluate', emp_id=user.id) }}" class="btn">Оценить</a>
            <a href="{{ url_for('views.send_feedback') }}" class="btn btn-outline">Обратная связь</a>
            <a href="{{ url_for('views.admin_news') }}" class="btn btn-outline">Новости</a>
            
            {% if user.role.name == 'admin' %}
                <a href="{{ url_for('views.admin_employees') }}" class="btn btn-outline">Сотрудники</a>
                <a href="{{ url_for('views.admin_faq') }}" class="btn btn-outline">FAQ</a>  
                <a href="{{ url_for('views.admin_messages') }}" class="btn btn-outline">Сообщения</a> 
                <a href="{{ url_for('views.admin_positions') }}" class="btn btn-outline">Должности</a>
            {% endif %}

            {% if user.role.name == 'manager' %}
                <a href="{{ url_for('views.admin_employees') }}" class="btn btn-outline">Сотрудники</a>
                <a href="{{ url_for('views.admin_positions') }}" class="btn btn-outline">Должности</a>
                <a href="{{ url_for('views.admin_metrics') }}" class="btn btn-outline">Метрики</a>
                <a href="{{ url_for('views.admin_cycles') }}" class="btn btn-outline">Циклы</a>
                <a href="{{ url_for('views.export_import') }}" class="btn">Импорт/Экспорт</a>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<div class="dash-action-links">
    <a href="{{ url_for('views.index') }}" class="btn btn-outline">На главную</a>
</div>

{% endblock %}